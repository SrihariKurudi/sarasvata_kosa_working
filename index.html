<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üìò ‡§∏‡§æ‡§∞‡§∏‡•ç‡§µ‡§§‡§ï‡•ã‡§∂‡§É ‚Äì English‚ÄìSanskrit Dictionary</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; margin: 2em; background: #f7f7f7; }
    h1 { margin-bottom: 1em; }

    .tabs, .upload-section { margin-bottom: 1em; }
    .tab-btn {
      padding: 0.5em 1em;
      margin-right: 0.5em;
      background-color: #ddd;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .tab-btn.active {
      background-color: #4a90e2;
      color: white;
    }

    .entry {
      background: white;
      padding: 1em;
      margin-bottom: 1em;
      border-left: 5px solid #4a90e2;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .headword { font-size: 1.3em; font-weight: bold; }
    .sanskrit { font-size: 1.1em; color: #00796b; margin-top: 0.2em; }
    .example, .notes { font-size: 0.95em; margin-top: 0.3em; }
    hr { border: none; border-top: 1px dashed #ccc; margin: 0.5em 0; }

    #upload { margin-top: 0.5em; }
  </style>
</head>
<body>

<h1>üìò ‡§∏‡§æ‡§∞‡§∏‡•ç‡§µ‡§§‡§ï‡•ã‡§∂‡§É ‚Äì English‚ÄìSanskrit Dictionary</h1>

<div class="upload-section">
  <strong>Upload CSV:</strong> <input type="file" id="upload" accept=".csv" />
</div>

<div class="tabs" id="tabs"></div>
<div id="dictionary"></div>

<script>
const sheetConfig = {
  "‡§≠‡•à‡§∑‡§ú‡•ç‡§Ø‡§Æ‡•ç": "https://docs.google.com/spreadsheets/d/1Cpr17CVMEdyH5vwbC8qMS4o9_vPmoxTGPSGhDviwTwA/gviz/tq?tqx=out:json&sheet=‡§≠‡•à‡§∑‡§ú‡•ç‡§Ø‡§Æ‡•ç",
  "‡§Æ‡§æ‡§π‡§æ‡§®‡§∏‡§ø‡§ï‡§Æ‡•ç": "https://docs.google.com/spreadsheets/d/1Cpr17CVMEdyH5vwbC8qMS4o9_vPmoxTGPSGhDviwTwA/gviz/tq?tqx=out:json&sheet=‡§Æ‡§æ‡§π‡§æ‡§®‡§∏‡§ø‡§ï‡§Æ‡•ç"
};

function renderTabs() {
  const tabBar = document.getElementById('tabs');
  Object.keys(sheetConfig).forEach((label, i) => {
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.className = 'tab-btn';
    if (i === 0) btn.classList.add('active');
    btn.onclick = () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      fetchSheet(sheetConfig[label]);
    };
    tabBar.appendChild(btn);
  });
}

function fetchSheet(url) {
  fetch(url)
    .then(res => res.text())
    .then(text => {
      let json;
      try {
        json = JSON.parse(text.match(/{.*}/s)[0]);
      } catch (err) {
        console.error("‚ùå JSON parse failed:", err);
        document.getElementById('dictionary').innerHTML = "<p style='color:red;'>‚ùå JSON parsing failed.</p>";
        return;
      }

      let cols = json.table.cols.map(c => c.label);
      const rawRows = json.table.rows;
      const firstRow = rawRows[0]?.c?.map(c => c?.v?.trim?.());
      const isHeaderRow = firstRow?.every(v => typeof v === 'string' && /^[A-Za-z]/.test(v));
      if ((!cols[0] || cols.every(l => l === "")) && isHeaderRow) {
        cols = firstRow;
        rawRows.shift();
      }

      const rows = rawRows.map(r => {
        const obj = {};
        r.c.forEach((cell, i) => {
          obj[cols[i]] = cell ? cell.v : "";
        });
        return obj;
      });

      renderEntries(rows);
    })
    .catch(err => {
      console.error("‚ùå Fetch error:", err);
      document.getElementById('dictionary').innerHTML = "<p style='color:red;'>‚ùå Failed to load data. Check sheet visibility or format.</p>";
    });
}

function renderEntries(data) {
  const container = document.getElementById('dictionary');
  container.innerHTML = '';

  const grouped = {};
  data.forEach(entry => {
    const key = entry.English?.trim();
    if (!key) return;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(entry);
  });

  for (let headword in grouped) {
    const group = grouped[headword];
    const div = document.createElement('div');
    div.className = 'entry';
    div.innerHTML = `<div class="headword">${headword}</div>`;
    group.forEach((e, i) => {
      div.innerHTML += `
        <div class="sanskrit">${e.Sanskrit}</div>
        ${e.Example ? `<div class="example">üìò ${e.Example}</div>` : ''}
        ${e.Notes ? `<div class="notes">üìù ${e.Notes}</div>` : ''}
        ${i < group.length - 1 ? `<hr>` : ''}
      `;
    });
    container.appendChild(div);
  }
}

document.getElementById('upload').addEventListener('change', function(e) {
  const file = e.target.files[0];
  Papa.parse(file, {
    header: true,
    dynamicTyping: true,
    complete: function(results) {
      const data = results.data;
      renderEntries(data);
    }
  });
});

renderTabs();
fetchSheet(Object.values(sheetConfig)[0]); // Load default sheet
</script>

</body>
</html>
